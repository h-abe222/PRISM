# PRISM VIP 本番システム構成設計書

## 1. システム概要

### 1.1 プロジェクト概要
- **サービス名**: PRISM VIP
- **目的**: 高額不動産投資物件の会員制情報提供サービス
- **想定ユーザー数**: Phase 1: 最大1,000名 → Phase 2: 最大10,000名
- **同時アクセス数**: Phase 1: 約100名 → Phase 2: 約1,000名
- **物件数**: Phase 1: 最大500件 → Phase 2: 最大5,000件
- **予算**: 初期構築20万円、ランニング費用は従量課金可

### 1.2 開発フェーズ

#### Phase 1: 半自動化システム（現在〜3ヶ月）
- 外部AI（Claude等）でPDF処理 → JSON生成
- 管理者によるデータ確認と付加情報入力
- 承認ワークフローによる品質保証
- 処理能力: 500物件/月

#### Phase 2: 完全自動化システム（3ヶ月後〜）
- PDFの自動取り込み（API/メール）
- AI自動処理・検証・分析
- 無人運用（24/7）
- 処理能力: 5,000物件/月

### 1.3 主要機能

#### Phase 1 機能
- 会員認証・管理
- 物件情報の段階的開示
- PDFドキュメント配信
- LINE連携（相談・通知）
- 管理画面（JSON形式でのデータ投入）
- 付加情報入力フォーム
- 承認ワークフロー

#### Phase 2 追加機能
- API経由の自動PDF取り込み
- マルチAI並列処理（Claude + GPT-4）
- 自動データ検証・補完
- PRISM AI分析エンジン
- リアルタイム処理通知
- 自動品質チェック・公開判定
- 予測的メンテナンス

## 2. システムアーキテクチャ

### 2.1 技術スタック

#### フロントエンド
- **ホスティング**: Vercel
- **フレームワーク**: Next.js 14
- **UI**: React + Tailwind CSS
- **状態管理**: React Context API

#### バックエンド
- **BaaS**: Supabase
- **データベース**: PostgreSQL
- **認証**: Supabase Auth
- **ストレージ**: Supabase Storage
- **API**: Supabase Edge Functions

#### 外部サービス
- **メール配信**: SendGrid
- **LINE連携**: LINE Messaging API
- **分析**: Google Analytics 4
- **CDN**: Vercel Edge Network

### 2.2 システム構成図

```
┌─────────────────────────────────────────────┐
│              ユーザー端末                      │
│         (PC/スマートフォン/タブレット)           │
└──────────────────┬──────────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────────┐
│            Vercel Edge Network               │
│              (CDN/キャッシュ)                  │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│         Vercel (フロントエンド)                │
│  ┌──────────────────────────────────────┐    │
│  │     Next.js アプリケーション            │    │
│  │  - 会員向けページ (/member/*)         │    │
│  │  - 物件詳細 (/properties/*)          │    │
│  │  - 管理画面 (/admin/*)              │    │
│  │  - 認証ページ (/auth/*)              │    │
│  └──────────────────────────────────────┘    │
└─────────────────┬───────────────────────────┘
                  │ API呼び出し
                  ▼
┌─────────────────────────────────────────────┐
│            Supabase Backend                  │
│  ┌──────────────────────────────────────┐    │
│  │        PostgreSQL Database           │    │
│  │  Tables:                             │    │
│  │  - users (会員情報)                   │    │
│  │  - properties (物件情報)              │    │
│  │  - documents (資料)                   │    │
│  │  - access_logs (アクセスログ)          │    │
│  │  - stage_permissions (閲覧権限)       │    │
│  └──────────────────────────────────────┘    │
│  ┌──────────────────────────────────────┐    │
│  │     Supabase Auth (認証)              │    │
│  │  - メール/パスワード認証               │    │
│  │  - セッション管理                      │    │
│  │  - パスワードリセット                   │    │
│  └──────────────────────────────────────┘    │
│  ┌──────────────────────────────────────┐    │
│  │   Supabase Storage (ファイル)          │    │
│  │  - PDF資料                           │    │
│  │  - 物件画像                          │    │
│  └──────────────────────────────────────┘    │
│  ┌──────────────────────────────────────┐    │
│  │   Edge Functions (サーバーレス関数)     │    │
│  │  - LINE通知送信                       │    │
│  │  - メール送信                         │    │
│  │  - データ検証                         │    │
│  └──────────────────────────────────────┘    │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│            外部サービス連携                     │
│  - LINE Messaging API (通知/相談)            │
│  - SendGrid (メール配信)                      │
│  - Google Analytics 4 (アクセス解析)          │
└─────────────────────────────────────────────┘
```

### 2.3 Phase 2: 完全自動化システム構成図

```
┌─────────────────────────────────────────────┐
│     不動産会社システム / メールサーバー          │
└──────────────────┬──────────────────────────┘
                   │ PDF送信（API/メール）
                   ▼
┌─────────────────────────────────────────────┐
│         自動取込みゲートウェイ                  │
│  - API エンドポイント                          │
│  - メール受信サーバー                          │
│  - ファイル検証                               │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│      AI処理パイプライン（並列処理）              │
│  ┌──────────────┬───────────────────────┐   │
│  │  Claude API  │    GPT-4 API         │   │
│  │  PDF解析     │    PDF解析            │   │
│  │  データ抽出   │    データ抽出          │   │
│  └──────────────┴───────────────────────┘   │
└──────────────────┬──────────────────────────┘
                   │ 結果マージ
                   ▼
┌─────────────────────────────────────────────┐
│         PRISM AI分析エンジン                  │
│  - データ検証・補完                            │
│  - 市場データ照合                             │
│  - 投資判断生成                               │
│  - リスク評価                                │
│  - 将来予測                                  │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│      自動品質チェック & 公開判定                │
│  - データ完全性チェック                        │
│  - ビジネスルール検証                         │
│  - 異常値検出                                │
│  - 自動公開判定                              │
└────────┬─────────┴──────────────────────────┘
         │                    │
    自動公開               エスカレーション
         ▼                    ▼
┌─────────────────┐  ┌─────────────────────┐
│  会員向け公開     │  │   管理者レビュー       │
│  - 自動通知      │  │   - 例外処理         │
│  - レポート生成   │  │   - 手動確認         │
└─────────────────┘  └─────────────────────┘
```

### 2.4 Phase 2 追加コンポーネント

#### AI処理エンジン
- **Claude API**: 高精度なPDF解析とデータ抽出
- **GPT-4 API**: 並列処理による精度向上
- **結果マージアルゴリズム**: 複数AI結果の最適統合

#### 自動化インフラ
- **メッセージキュー**: AWS SQS / RabbitMQ
- **ワークフロー管理**: Temporal / Apache Airflow
- **監視**: Datadog / New Relic
- **ログ集約**: ELK Stack

#### スケーリング対応
- **オートスケーリング**: Vercel自動スケール
- **データベース**: Supabase Pro（接続プール拡張）
- **キャッシュ**: Redis（Upstash）
- **CDN**: Cloudflare（グローバル配信）

## 3. データベース設計

### 3.1 テーブル構成

#### users (会員情報)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  phone VARCHAR(20),
  company VARCHAR(200),
  annual_income BIGINT, -- 年収（機密情報）
  investment_experience VARCHAR(50),
  stage INTEGER DEFAULT 1, -- 現在のステージ
  line_user_id VARCHAR(255), -- LINE連携用
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP -- 論理削除
);
```

#### properties (物件情報)
```sql
CREATE TABLE properties (
  id VARCHAR(10) PRIMARY KEY, -- 例: "001"
  title VARCHAR(200) NOT NULL,
  location VARCHAR(200),
  price BIGINT,
  yield_rate DECIMAL(5,2),
  property_type VARCHAR(100),
  area VARCHAR(50),
  data JSONB, -- 詳細データ（JSON形式）
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### documents (資料)
```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  property_id VARCHAR(10) REFERENCES properties(id),
  title VARCHAR(200),
  file_path VARCHAR(500),
  file_type VARCHAR(50),
  required_stage INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### access_logs (アクセスログ)
```sql
CREATE TABLE access_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  property_id VARCHAR(10),
  action VARCHAR(50),
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## 4. セキュリティ設計

### 4.1 認証・認可
- **認証方式**: メール/パスワード（Supabase Auth）
- **セッション管理**: JWT トークン（有効期限: 7日）
- **権限管理**: Row Level Security (RLS)

### 4.2 データ保護
- **通信**: 全通信HTTPS化
- **データベース**: 暗号化（AES-256）
- **個人情報**: 
  - 年収等の機密情報は暗号化して保存
  - アクセスログを記録
  - 論理削除を使用

### 4.3 バックアップ
- **頻度**: 日次自動バックアップ
- **保持期間**: 30日間
- **リストア**: Supabase管理画面から実行可能

## 5. 外部サービス連携

### 5.1 LINE Messaging API
- **用途**: 
  - 新規物件通知
  - ステージアップ通知
  - 個別相談対応
- **実装**: Supabase Edge Functions経由

### 5.2 SendGrid
- **用途**:
  - 会員登録確認メール
  - パスワードリセット
  - 重要なお知らせ
- **月間送信数**: 約1,000通想定

## 6. 管理画面機能

### 6.1 機能一覧
- 会員管理（一覧/詳細/ステージ変更）
- 物件管理（JSON形式での一括投入/編集）
- 資料管理（PDFアップロード）
- アクセスログ確認
- 通知送信

### 6.2 JSON投入形式
```json
{
  "id": "001",
  "title": "PRISM南青山プレミアムレジデンス",
  "location": "港区南青山",
  "price": 680000000,
  "yield_rate": 6.35,
  "property_type": "デザイナーズマンション",
  "area": "港区",
  "details": {
    "overview": { ... },
    "simulation": { ... },
    "valuation": { ... },
    "finance": { ... },
    "summary": { ... }
  }
}
```

## 7. 実装フェーズ

### Phase 1: 基本機能実装（4-6週間）
- [ ] Supabase セットアップ
- [ ] データベース構築
- [ ] 認証システム実装
- [ ] 基本的な会員機能
- [ ] 物件表示機能

### Phase 2: 管理機能実装（2-3週間）
- [ ] 管理画面UI
- [ ] JSON投入機能
- [ ] 会員管理機能
- [ ] PDF管理機能

### Phase 3: 外部連携実装（2週間）
- [ ] LINE Messaging API連携
- [ ] SendGrid連携
- [ ] Google Analytics設定

### Phase 4: セキュリティ・運用（1週間）
- [ ] セキュリティテスト
- [ ] バックアップ設定
- [ ] 監視設定
- [ ] ドキュメント整備

## 8. コスト見積もり

### 8.1 初期費用
- 開発費用: 20万円以内
- ドメイン取得: 約2,000円/年
- SSL証明書: Vercel/Supabase標準提供（無料）

### 8.2 月額ランニングコスト
| サービス | プラン | 月額費用 |
|---------|--------|----------|
| Vercel | Pro | 約2,500円 |
| Supabase | Pro | 約3,500円 |
| SendGrid | Essentials | 約1,000円 |
| **合計** | | **約7,000円** |

※従量課金により変動あり

## 9. 監視・運用

### 9.1 監視項目
- サーバー稼働率（目標: 99.9%）
- レスポンスタイム
- エラー率
- データベース使用量

### 9.2 アラート設定
- サービス停止
- エラー率上昇
- 不正アクセス検知

## 10. 今後の拡張性

### 10.1 将来的な機能追加
- AI物件レコメンド
- チャット機能
- VR内見
- 電子契約

### 10.2 スケーラビリティ
- Vercel: 自動スケーリング対応
- Supabase: 最大10,000同時接続まで対応可能
- 必要に応じてプラン変更で対応

---
*最終更新日: 2024年9月4日*